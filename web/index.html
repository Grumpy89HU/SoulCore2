<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulCore 2.0 - Sovereign Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Inter', 'Segoe UI', sans-serif; }
        .sidebar { background: #161b22; border-right: 1px solid #30363d; }
        .terminal-bg { background: rgba(22, 27, 34, 0.95); }
        .tab-btn.active { border-left: 3px solid #2563eb; background: #1c2128; color: white; }
        .response-text { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
        .chat-item.active { background-color: #1c2128; border-left: 3px solid #2563eb; color: white; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .thinking { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="h-screen overflow-hidden flex">

    <aside class="sidebar w-72 flex flex-col p-4 space-y-4">
        <div class="font-bold text-blue-500 tracking-tighter text-xl mb-4 flex items-center gap-2">
            <div class="h-3 w-3 bg-blue-500 rounded-full animate-pulse shadow-[0_0_10px_#3b82f6]"></div> 
            SOULCORE <span class="text-gray-500 font-light">2.0</span>
        </div>
        
        <button onclick="newChat()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl text-sm font-bold transition-all shadow-lg flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> 
            √öj cseveg√©s
        </button>

        <div class="flex-grow flex flex-col overflow-hidden">
            <p class="text-[10px] uppercase font-bold text-gray-600 px-2 mt-4 mb-2 tracking-widest">Mem√≥ria Slotok</p>
            <div id="chat-history-list" class="flex-grow overflow-y-auto space-y-1 pr-2 text-gray-400"></div>
        </div>

        <div class="border-t border-gray-800 pt-4">
            <p class="text-[10px] uppercase font-bold text-gray-600 px-2 mb-2 tracking-widest">Rendszernapl√≥</p>
            <div id="system-logs" class="h-32 overflow-y-auto bg-black/20 rounded p-2 font-mono text-[9px] text-gray-500">
                <div>> Kernel v2.0 ready.</div>
            </div>
        </div>

        <div class="space-y-1 pt-2">
            <button onclick="toggleSettings()" class="w-full text-left p-2 hover:bg-gray-800 rounded text-xs flex items-center gap-2 transition-colors">‚öôÔ∏è Be√°ll√≠t√°sok</button>
            <button onclick="location.href='/logout'" class="w-full text-left p-2 hover:bg-red-900/10 text-red-500 rounded text-xs flex items-center gap-2 transition-colors">üö™ Kil√©p√©s</button>
        </div>
    </aside>

    <section class="flex-grow flex flex-col relative">
        <nav class="p-3 border-b border-gray-800 flex justify-between items-center bg-[#161b22]/50 backdrop-blur-md">
            <div id="gpu-stats" class="text-[10px] text-gray-500 font-mono tracking-wider">TELEMETRIA: BET√ñLT√âS...</div>
            <div class="flex items-center gap-4">
                <div class="flex flex-col items-end">
                    <span class="text-[9px] text-gray-600 font-mono uppercase" id="kernel-uptime">Uptime: 0s</span>
                    <span class="text-[10px] text-emerald-500 font-bold" id="status-text">ONLINE</span>
                </div>
                <div id="status-dot" class="h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
            </div>
        </nav>

        <main id="chat-box" class="flex-grow overflow-y-auto p-6 space-y-6 scroll-smooth">
            <div class="h-full flex items-center justify-center opacity-20 flex-col">
                <div class="text-4xl mb-4">üè∞</div>
                <div class="font-mono text-[10px] tracking-[0.5em] uppercase text-center">A V√°r Szuver√©n Ter√ºlete</div>
            </div>
        </main>

        <footer class="p-6 bg-[#0d1117]">
            <div class="max-w-4xl mx-auto relative">
                <input type="text" id="user-input" autocomplete="off"
                    class="w-full bg-[#161b22] border border-gray-800 rounded-2xl py-4 px-6 focus:outline-none focus:border-blue-600 text-gray-200 shadow-2xl transition-all" 
                    placeholder="√çrj K√≥p√©nak...">
                <button onclick="sendMessage()" class="absolute right-4 top-3.5 p-1.5 bg-blue-600 rounded-lg text-white hover:bg-blue-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </footer>
    </section>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="w-[800px] h-[600px] bg-[#161b22] border border-gray-700 rounded-3xl flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <span class="font-bold text-sm text-blue-400">RENDSZERVEZ√âRL√âS</span>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-white">‚úï</button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto" id="settings-content">
                <p class="text-gray-500 text-sm italic">Adatok lek√©r√©se a Kernelt≈ël...</p>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = "chat_" + Date.now();
        let isProcessing = false;

        async function updateStats() {
            try {
                const res = await fetch('/status');
                const data = await res.json();
                if (data.hardware && data.hardware.length > 0) {
                    const gpu = data.hardware[0];
                    document.getElementById('gpu-stats').innerHTML = `
                        <span class="text-blue-500">GPU:</span> ${gpu.temp} | 
                        <span class="text-blue-500">VRAM:</span> ${gpu.vram_used_mb}MB / ${gpu.vram_total_mb}MB (${gpu.vram_usage_pct}%) | 
                        <span class="text-blue-500">LOAD:</span> ${gpu.gpu_load_pct}%`;
                }
                document.getElementById('kernel-uptime').innerText = `Uptime: ${data.kernel.uptime}s`;
            } catch (e) {}
        }

        async function loadChatHistory() {
            const res = await fetch('/chats/list');
            const chats = await res.json();
            const list = document.getElementById('chat-history-list');
            list.innerHTML = chats.map(c => `
                <button onclick="loadChat('${c.chat_id}')" class="chat-item w-full text-left p-2 rounded text-[11px] hover:bg-gray-800 transition-all truncate ${c.chat_id === currentChatId ? 'active' : ''}">
                    ‚óè ${c.title || 'Munkamenet'}
                </button>
            `).join('');
        }

        async function sendMessage() {
            if(isProcessing) return;
            const input = document.getElementById('user-input');
            const query = input.value.trim();
            if(!query) return;

            renderMessage('user', query);
            input.value = "";
            isProcessing = true;
            
            // "Thinking" indik√°tor
            const thinkingId = 'think_' + Date.now();
            document.getElementById('chat-box').innerHTML += `<div id="${thinkingId}" class="thinking text-[10px] text-blue-900 font-mono italic">K√≥p√© gondolkodik...</div>`;

            try {
                const res = await fetch('/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, chat_id: currentChatId})
                });
                const data = await res.json();
                document.getElementById(thinkingId).remove();
                renderMessage('assistant', data.response);
                addLog(`V√°lasz √©rkezett: ${data.metadata.tokens || 0} token`);
            } catch (e) {
                addLog("ERROR: Kernel nem v√°laszol.");
            } finally {
                isProcessing = false;
            }
        }

        function renderMessage(role, content) {
            const box = document.getElementById('chat-box');
            const msg = document.createElement('div');
            msg.className = role === 'user' ? 'flex justify-end mb-4' : 'mb-6';
            
            if (role === 'user') {
                msg.innerHTML = `<div class="bg-blue-600/20 border border-blue-500/30 text-blue-100 p-3 px-5 rounded-2xl max-w-xl text-sm">${content}</div>`;
            } else {
                msg.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-[9px] text-blue-500 font-bold mb-1 ml-1 tracking-widest uppercase">K√≥p√©</span>
                        <div class="bg-[#161b22] border border-gray-800 p-4 rounded-2xl max-w-3xl text-sm text-gray-200 response-text shadow-sm border-l-2 border-l-blue-600">${content}</div>
                    </div>`;
            }
            box.appendChild(msg);
            box.scrollTop = box.scrollHeight;
        }

        function addLog(msg) {
            const logs = document.getElementById('system-logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div class="mb-1"><span class="text-gray-700">[${time}]</span> ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function newChat() {
            currentChatId = "chat_" + Date.now();
            document.getElementById('chat-box').innerHTML = "";
            addLog("√öj szuver√©n csatorna nyitva.");
            loadChatHistory();
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        setInterval(updateStats, 3000);
        window.onload = () => { updateStats(); loadChatHistory(); };
    </script>
</body>
</html>