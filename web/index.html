<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulCore 2.0 - Sovereign Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Inter:wght@300;400;600&display=swap');
        
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Inter', sans-serif; }
        .sidebar { background: #161b22; border-right: 1px solid #30363d; }
        .terminal-bg { background: rgba(22, 27, 34, 0.95); }
        .response-text { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; font-size: 0.9rem; }
        .chat-item.active { background-color: #1c2128; border-left: 3px solid #2563eb; color: white; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .thinking { animation: pulse-soft 1.5s infinite; font-family: 'Fira Code', monospace; }
        
        .glass-nav { background: rgba(22, 27, 34, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid #30363d; }
        .vram-chip { background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.2); }
        
        /* Custom Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363d; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="h-screen overflow-hidden flex">

    <aside class="sidebar w-72 flex flex-col p-4 space-y-4 shadow-2xl z-20">
        <div class="font-bold text-blue-500 tracking-tighter text-xl mb-4 flex items-center gap-2 px-2">
            <div class="h-3 w-3 bg-blue-500 rounded-full animate-pulse shadow-[0_0_12px_#3b82f6]"></div> 
            SOULCORE <span class="text-gray-500 font-light">2.0</span>
        </div>
        
        <button onclick="newChat()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-sm font-bold transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> 
            √öj cseveg√©s
        </button>

        <div class="flex-grow flex flex-col overflow-hidden">
            <p class="text-[10px] uppercase font-bold text-gray-600 px-2 mt-4 mb-2 tracking-[0.2em]">Mem√≥ria Slotok</p>
            <div id="chat-history-list" class="flex-grow overflow-y-auto space-y-1 pr-2 text-gray-400 font-medium"></div>
        </div>

        <div class="border-t border-gray-800 pt-4">
            <p class="text-[10px] uppercase font-bold text-gray-600 px-2 mb-2 tracking-widest">Rendszernapl√≥</p>
            <div id="system-logs" class="h-32 overflow-y-auto bg-black/40 rounded-lg p-3 font-mono text-[9px] text-gray-500 border border-gray-800/50">
                <div class="text-blue-900">> Kernel connection established.</div>
            </div>
        </div>

        <div class="space-y-1 pt-2 border-t border-gray-800">
            <button onclick="toggleSettings()" class="w-full text-left p-2 hover:bg-gray-800 rounded-lg text-xs flex items-center gap-2 transition-colors text-gray-400">‚öôÔ∏è Be√°ll√≠t√°sok</button>
            <button onclick="location.href='/logout'" class="w-full text-left p-2 hover:bg-red-900/10 text-red-500 rounded-lg text-xs flex items-center gap-2 transition-colors">üö™ Kil√©p√©s</button>
        </div>
    </aside>

    <section class="flex-grow flex flex-col relative bg-[#0d1117]">
        <nav class="p-3 glass-nav flex justify-between items-center z-10">
            <div id="gpu-stats" class="flex gap-3 overflow-x-auto no-scrollbar">
                <div class="vram-chip px-3 py-1 rounded-md text-[10px] text-blue-400 font-mono flex items-center gap-2">
                    <span class="animate-pulse">‚óè</span> TELEMETRY LOADING...
                </div>
            </div>
            
            <div class="flex items-center gap-4 px-2">
                <div class="flex flex-col items-end">
                    <span class="text-[9px] text-gray-600 font-mono uppercase" id="kernel-uptime">Uptime: 0s</span>
                    <span class="text-[10px] text-emerald-500 font-bold tracking-widest" id="status-text">ONLINE</span>
                </div>
                <div id="status-dot" class="h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]"></div>
            </div>
        </nav>

        <main id="chat-box" class="flex-grow overflow-y-auto p-8 space-y-8 scroll-smooth">
            <div class="h-full flex items-center justify-center opacity-10 flex-col pointer-events-none">
                <div class="text-6xl mb-6">üè∞</div>
                <div class="font-mono text-[12px] tracking-[0.8em] uppercase text-center">Szuver√©n Adatt√©r</div>
            </div>
        </main>

        <footer class="p-6 bg-gradient-to-t from-[#0d1117] to-transparent">
            <div class="max-w-4xl mx-auto relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl opacity-10 group-focus-within:opacity-30 transition-opacity"></div>
                <input type="text" id="user-input" autocomplete="off"
                    class="relative w-full bg-[#161b22] border border-gray-800 rounded-2xl py-4 px-6 focus:outline-none focus:border-blue-600 text-gray-200 shadow-2xl transition-all placeholder-gray-600" 
                    placeholder="K√ºldj parancsot vagy k√©rd√©st K√≥p√©nak...">
                <button onclick="sendMessage()" class="absolute right-4 top-3 p-2 bg-blue-600 rounded-xl text-white hover:bg-blue-500 transition-all active:scale-90 shadow-lg shadow-blue-900/40">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="text-center mt-3">
                <p class="text-[9px] text-gray-700 font-mono tracking-widest uppercase">SoulCore Kernel v2.0 - Szuver√©n Entit√°s</p>
            </div>
        </footer>
    </section>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl h-[80vh] bg-[#161b22] border border-gray-700 rounded-3xl flex flex-col overflow-hidden shadow-2xl">
            <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-[#1c2128]">
                <div class="flex items-center gap-3">
                    <div class="h-2 w-2 bg-blue-500 rounded-full animate-ping"></div>
                    <span class="font-bold text-sm text-blue-400 tracking-widest">SYSTEM CONTROL PANEL</span>
                </div>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-white transition-colors p-2 hover:bg-gray-800 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-grow p-8 overflow-y-auto" id="settings-content">
                </div>
        </div>
    </div>

    <script>
        let currentChatId = localStorage.getItem('lastChatId') || "chat_" + Date.now();
        let isProcessing = false;

        async function updateStats() {
            try {
                const res = await fetch('/status');
                if (!res.ok) throw new Error("Kernel unreachable");
                const data = await res.json();
                const gpuContainer = document.getElementById('gpu-stats');

                if (data.hardware && data.hardware.length > 0) {
                    gpuContainer.innerHTML = data.hardware.map((hw) => {
                        const load = hw.load_pct ?? hw.usage ?? 0;
                        const used = hw.vram_used_mb ?? 0;
                        const total = hw.vram_total_mb ?? 0;
                        const temp = hw.temp ?? 0;
                        const isRAM = hw.type === 'system';

                        return `
                            <div class="vram-chip px-3 py-1 rounded-md text-[10px] font-mono flex items-center gap-2 border border-blue-500/20">
                                <span class="${isRAM ? 'text-emerald-400' : 'text-blue-500'} font-bold">${hw.name}</span>
                                <span class="text-gray-400">${load}%</span>
                                <span class="text-gray-600">|</span>
                                <span class="text-blue-400">${used} MB</span>
                                ${!isRAM && temp > 0 ? `<span class="text-xs ${temp > 70 ? 'text-red-500' : 'text-orange-400'}">${temp}¬∞C</span>` : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('kernel-uptime').innerText = `Uptime: ${data.kernel?.uptime || 0}s`;
                document.getElementById('status-text').innerText = "ONLINE";
                document.getElementById('status-dot').className = "h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
            } catch (e) {
                document.getElementById('status-text').innerText = "OFFLINE";
                document.getElementById('status-dot').className = "h-2.5 w-2.5 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]";
            }
        }

        async function saveConfig(key, value) {
            try {
                const res = await fetch('/config/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ [key]: value })
                });
                if(res.ok) addLog(`Update: ${key} set to ${value}`);
            } catch (e) { addLog("Hiba a ment√©sn√©l."); }
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                fetch('/status').then(r => r.json()).then(data => {
                    const kernel = data.kernel || {};
                    const hardware = data.hardware || [];
                    const config = data.config || { temperature: 0.7, rag_enabled: true };

                    document.getElementById('settings-content').innerHTML = `
                        <div class="space-y-10 pb-10">
                            <section>
                                <h3 class="text-blue-500 text-xs font-bold mb-6 tracking-[0.2em] uppercase flex items-center gap-2">
                                    <span class="h-[1px] w-8 bg-blue-500/30"></span> Engine Parameters
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 bg-black/30 p-8 rounded-3xl border border-gray-800">
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                            <label class="text-xs text-gray-400 font-medium">Temperature (Creativity)</label>
                                            <span class="font-mono text-blue-500 text-xs" id="temp-val">${config.temperature}</span>
                                        </div>
                                        <input type="range" min="0" max="1.5" step="0.1" value="${config.temperature}" 
                                            oninput="document.getElementById('temp-val').innerText = this.value"
                                            onchange="saveConfig('temperature', this.value)"
                                            class="w-full h-1.5 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                        <div class="flex justify-between text-[9px] text-gray-600 uppercase"><span>Precise</span><span>Creative</span></div>
                                    </div>
                                    <div class="flex flex-col justify-center space-y-6">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-xs text-gray-200">RAG Module</div>
                                                <div class="text-[10px] text-gray-500">Enable neural long-term memory</div>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" ${config.rag_enabled ? 'checked' : ''} onchange="saveConfig('rag_enabled', this.checked)">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 class="text-emerald-500 text-xs font-bold mb-6 tracking-[0.2em] uppercase flex items-center gap-2">
                                    <span class="h-[1px] w-8 bg-emerald-500/30"></span> Resource Allocation
                                </h3>
                                <div class="grid grid-cols-1 gap-4">
                                    ${hardware.map(hw => `
                                        <div class="flex items-center justify-between bg-black/20 p-5 rounded-2xl border border-gray-800/50 hover:border-gray-700 transition-colors">
                                            <div class="flex items-center gap-4">
                                                <div class="h-10 w-10 rounded-xl bg-gray-800/50 flex items-center justify-center text-xl shadow-inner">
                                                    ${hw.type === 'system' ? 'üß†' : '‚ö°'}
                                                </div>
                                                <div>
                                                    <div class="text-sm font-bold text-gray-200">${hw.name}</div>
                                                    <div class="text-[10px] text-gray-500 font-mono italic">${hw.type === 'system' ? 'Host Memory' : 'Inference Accelerator'}</div>
                                                </div>
                                            </div>
                                            <div class="flex gap-10 items-center font-mono">
                                                <div class="text-right">
                                                    <div class="text-[9px] text-gray-600 uppercase tracking-tighter">Load</div>
                                                    <div class="text-sm ${hw.load_pct > 80 ? 'text-red-400' : 'text-emerald-400'}">${hw.load_pct ?? 0}%</div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-[9px] text-gray-600 uppercase tracking-tighter">VRAM</div>
                                                    <div class="text-sm text-blue-400">${hw.vram_used_mb ?? 0} MB</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </section>

                            <details class="opacity-30 hover:opacity-100 transition-all duration-500">
                                <summary class="text-[10px] cursor-pointer text-gray-600 uppercase font-bold tracking-widest">Advanced Kernel Telemetry</summary>
                                <pre class="p-6 bg-black/60 rounded-2xl text-[10px] mt-4 overflow-x-auto text-blue-800 border border-blue-900/10 font-mono">${JSON.stringify(data, null, 4)}</pre>
                            </details>
                        </div>
                    `;
                });
            }
        }

        // --- CORE CHAT LOGIC ---
        async function loadChatHistory() {
            try {
                const res = await fetch('/chats/list');
                const chats = await res.json();
                const list = document.getElementById('chat-history-list');
                list.innerHTML = chats.map(c => `
                    <button onclick="loadChat('${c.chat_id}')" class="chat-item w-full text-left p-3 rounded-xl text-[11px] hover:bg-gray-800/50 transition-all truncate border border-transparent ${c.chat_id === currentChatId ? 'active' : ''}">
                        <span class="opacity-50 mr-2">#</span> ${c.title || '√öj Munkamenet'}
                    </button>
                `).join('');
            } catch (e) { addLog("History error."); }
        }

        async function loadChat(chat_id) {
            currentChatId = chat_id;
            localStorage.setItem('lastChatId', chat_id);
            document.getElementById('chat-box').innerHTML = "";
            loadChatHistory();
            const res = await fetch(`/chats/history/${chat_id}`);
            const history = await res.json();
            history.forEach(msg => renderMessage(msg.role, msg.content));
            addLog(`Munkamenet: ${chat_id}`);
        }

        async function sendMessage() {
            if(isProcessing) return;
            const input = document.getElementById('user-input');
            const query = input.value.trim();
            if(!query) return;

            renderMessage('user', query);
            input.value = "";
            isProcessing = true;
            
            const thinkingId = 'think_' + Date.now();
            document.getElementById('chat-box').innerHTML += `
                <div id="${thinkingId}" class="flex flex-col mb-6">
                    <span class="text-[9px] text-blue-500 font-bold mb-1 ml-1 tracking-widest uppercase thinking">Neural processing...</span>
                    <div class="bg-[#161b22] border border-blue-900/20 p-4 rounded-2xl max-w-sm text-[10px] text-blue-400/50 font-mono italic">
                        K√≥p√© gondolkodik...
                    </div>
                </div>`;
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;

            try {
                const res = await fetch('/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, chat_id: currentChatId})
                });
                const data = await res.json();
                document.getElementById(thinkingId).remove();
                renderMessage('assistant', data.response);
            } catch (e) {
                document.getElementById(thinkingId).innerHTML = "<span class='text-red-500'>Hiba: Kernel timeout.</span>";
            } finally {
                isProcessing = false;
                loadChatHistory();
            }
        }

        function renderMessage(role, content) {
            const box = document.getElementById('chat-box');
            const msg = document.createElement('div');
            msg.className = role === 'user' ? 'flex justify-end mb-4 animate-in slide-in-from-right-4 duration-300' : 'mb-6 animate-in slide-in-from-left-4 duration-300';
            
            if (role === 'user') {
                msg.innerHTML = `<div class="bg-blue-600/10 border border-blue-500/20 text-blue-50 text-sm p-4 px-6 rounded-3xl rounded-tr-none max-w-[80%] shadow-sm">${content}</div>`;
            } else {
                msg.innerHTML = `
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2 mb-2 ml-1">
                            <span class="text-[10px] text-blue-500 font-bold tracking-[0.2em] uppercase">K√ìP√â</span>
                            <span class="text-[9px] text-gray-600 font-mono">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="bg-[#161b22] border border-gray-800 p-5 rounded-3xl rounded-tl-none max-w-[95%] text-gray-200 response-text shadow-xl">
                            ${content}
                        </div>
                    </div>`;
            }
            box.appendChild(msg);
            box.scrollTop = box.scrollHeight;
        }

        function addLog(msg) {
            const logs = document.getElementById('system-logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div class="mb-1 border-l border-gray-800 pl-2"><span class="text-gray-700 text-[8px]">[${time}]</span> <span class="text-gray-400">${msg}</span></div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function newChat() {
            currentChatId = "chat_" + Date.now();
            localStorage.setItem('lastChatId', currentChatId);
            document.getElementById('chat-box').innerHTML = `<div class="h-full flex items-center justify-center opacity-10 flex-col pointer-events-none"><div class="text-6xl mb-6">üè∞</div><div class="font-mono text-[12px] tracking-[0.8em] uppercase text-center">√öj Szuver√©n Adatt√©r</div></div>`;
            loadChatHistory();
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        setInterval(updateStats, 3000);
        window.onload = () => { updateStats(); loadChatHistory(); if(localStorage.getItem('lastChatId')) loadChat(localStorage.getItem('lastChatId')); };
    </script>
</body>
</html>